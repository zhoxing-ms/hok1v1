环境介绍
环境使用
用户可以在<算法名称>/train_workflow.py的workflow函数的参数中获取Hok1v1的env:

def workflow(envs, agents, logger=None, monitor=None):
    # 从环境列表中获得环境, get env from envs(env-list)
    env = envs[0] 

环境env有两个接口: reset 和 step，用户可以简单地通过以下方式来调用Hok1v1环境：

obs, state_dicts = env.reset(usr_conf=usr_conf)
frame_no, obs, reward, terminated, truncated, state_dicts = env.step(actions)

其中 reset是重启环境，step是将环境往前推进一步，step返回的frame_no是任务帧数，obs为None，因为观测数据被整合在state_dicts的observation中，reward为None，这部分需要由用户实现，terminated表示对局结束，即分出胜负，truncated表示任务中断（超时或异常）,state_dicts是最重要的，表示了环境状态（state）信息，我们会在后续的篇幅详细介绍。

环境配置
用户可以在reset时传入一个usr_conf来实现定制化的环境配置。

usr_conf是一个字典类型，需要先定义一个 key 叫做 diy，diy的值包含一些键值对:

数据名	数据类型	数据描述
monitor_side	int	监控上报的阵营，统计指标以该阵营为第一视角，0为蓝方阵营，1为红方阵营，例如蓝方战胜红方，若monitor_side设为0则胜率为1，若monitor_side设为1则胜率为0，类型为整数，范围：[0, 1]
monitor_label	string	监控上报的标签，标签有三种类型：1."selfplay"，上报到env监控面板，用于监控自对弈的对局指标；2."common_ai"，上报到eval监控面板，并且在monitor_side的对手阵营将启动一个common_ai; 3.自定义的模型id，如“1234”，上报到eval监控面板。env会根据monitor_label的不同，在不同监控面板显示对局的指标
lineups	list	阵容配置，列表有且只有两个元素，分别代表蓝方阵容和红方阵容，通过配置hero_id选择阵容中的英雄，hero_id范围：[133, 199, 508]
💡 补充说明：

在Hok1v1环境中，存在两个阵营（分别为红和蓝），每个阵营中分别有一名游戏角色（被称为英雄），红蓝阵营进行对战，一方阵营达到胜利条件则一局对战结束
common_ai指的是环境内置的一个基于规则的AI，能力略弱于普通玩家。通过将monitor_label设置为common_ai可在其中一个阵营启用。
monitor_label若设置为common_ai，则env会启动一个common_ai且阵营为monitor_side的对手阵营。例如monitor_side设置为0，则红方将启动一个common_ai，此时env.step传入的红方action会被common_ai的action覆盖。
usr_conf仅在训练时生效。
hero_id对应关系：133->狄仁杰，508->伽罗，199->公孙离
英雄默认配置的召唤师技能为闪现
下面提供若干usr_conf设置实例：

例子#1

# 该对局，蓝方为狄仁杰（133），红方为伽罗（508），不启用common_ai
# 上报红方的对局数据到监控中标签为env的面板（因为monitor_side被设置为红方）
usr_conf = {
  "diy":{
    "monitor_side": 1,
    "monitor_label": "selfplay",
    "lineups": [[{'hero_id': 133}], [{'hero_id': 508}]],
  }
}

descript例子#2

# 该对局，蓝方为狄仁杰（133），红方为伽罗（508）, 红方使用common_ai（因为monitor_side被设置为蓝方，且monitor_label被设置为common_ai）
# 上报蓝方的对局数据到监控中标签为eval的面板，面板中的“common_ai”选项表示的曲线即监控内容
usr_conf = {
  "diy":{
    "monitor_side": 0,
    "monitor_label": "common_ai",
    "lineups": [[{'hero_id': 133}], [{'hero_id': 508}]],
  }
}


descript例子#3

# 该对局，蓝方为狄仁杰（133），红方为伽罗（508），不启用common_ai
# 上报红方的对局数据到监控中标签为eval的面板，面板中的“2057”选项表示的曲线即监控内容
model_id = "2057"
usr_conf = {
  "diy":{
    "monitor_side": 1,
    "monitor_label": model_id,
    "lineups": [[{'hero_id': 133}], [{'hero_id': 508}]],
  }
}

descript

环境介绍
执行env.step(actions)之后会返回下一帧的帧状态state_dict，包含环境所有的状态信息, 大致形式如下:

state_dict[agent_id] = {
    "game_id": 1234,
    "player_id": 8,
    "frame_no": 30,
    "observation": array([1.00000000e00, 1.00000000e00, 0.00000000e00, 0.00000000e00, ...]),
    "reward": 0.0,
    "legal_action": array([1.0, 1.0, 1.0, 0.0, 0.0, ...]),
    "sub_action_mask": {
        0: array([1.0, 0.0, 0.0, 0.0, 0.0, 0.0]),
        1: array([1.0, 0.0, 0.0, 0.0, 0.0, 0.0]),
        ...
        11: array([1.0, 0.0, 0.0, 0.0, 0.0, 0.0]),
    },
    "frame_state": hok.hok1v1.lib.interface.AIFrameState,
}


提示: 在开发的过程中, 可以直接在相关逻辑处下断点, 直接获取运行时的变量的类型/值/形状

观测空间
智能体的观测数据在state_dict[agent_id]["observation"]中，注意两个智能体获得观测是不同的，观测可以直接作为特征，以下是各个子项的说明：

特征区间名	特征维数	举例
Main_camp_hero_state_common_feature	102	血量，位置
Main_camp_hero_private_feature	133	鲁班第几次普攻
Enemy_camp_hero_state_common_feature	102	血量，位置
Enemy_camp_hero_private_feature	133	鲁班第几次普攻
Public_feature	14	敌方小兵是否在我方塔下
Main_camp_soldier_feature	18*4	我方小兵1位置，血量
Enemy_camp_soldier_feature	18*4	敌方小兵1位置，血量
Main_camp_organ_feature	18*2	我方防御塔血量，位置
Enemy_camp_organ_feature	18*2	敌方防御塔血量，位置
Global_feature	5	当前对局处于前中后哪个时期
demo_custom_feature	20	自定义特征示例 (20维 hero id)
英雄特征经过视野过滤, 当敌方英雄不在视野中时, 敌方英雄部分特征会被置为默认值。

通过在程序中调用env.step或env.reset，游戏引擎会返回当前帧的状态数据，从中可以获取到英雄血量、技能信息、防御塔信息等数值。以下描述了不同数据的计算方法：

对于位置特征：考虑到Hok1v1中地图相对于对战双方而言是镜像对称的，在双方眼中其都处于地图左下角，故使用相对位置特征，将处于地图右上角的英雄的特征数据进行镜像反转，将其转换为左下角位置。

对于技能子弹特征：例如貂蝉大招与鲁班七号大招的实时位置，都可以通过帧状态中bullet的位置数据来获得。

对于强化普攻类特征：比如鲁班被动，记录其第几次强化特征（one-hot编码），或者当前是否有强化普攻。

动作空间
王者1v1强化项目使用层次化的动作空间，将所有动作分为以下几类：

what，你要按哪个按键：12个button

how，你要往哪个方向拖动按键：16*16个方向选择

who，你的技能作用对象是谁：9个target（None，敌我两个英雄，四个兵，一个塔，一个野怪）

descript

动作空间各维度说明
Action Class	Type	Description	Dimension
Button	None	No action	1
None	No action	1
Move	Move hero	1
Normal Attack	Release normal attack	1
Skill 1	Release 1st skill	1
Skill 2	Release 2nd skill	1
Skill 3	Release 3rd skill	1
Heal Skill	Release heal skill	1
Chosen Skill	Release the chosen skill	1
Recall	Start channeling and return to the home fountain after a few seconds if not interrupted	1
Skill 4	Release 4th skill (Only valid for certain heroes)	1
Equipment Skill	Release skill provided by certain equipment	1
Move	Move X	Move direction along X-axis	16
Move Z	Move direction along Z-axis	16
Skill	Skill X	Skill direction along X-axis	16
Skill Z	Skill direction along Z-axis	16
Target	None	Empty target	1
Enemy	Enemy player	1
Self	Self player	1
Soldier	Four nearest soldiers	4
Tower	Nearest tower	1
Action Mask 机制
Sub action mask (对应state_dict["sub_action_mask"]):

根据button类型对剩余action进行选择性过滤
原因：并非所有技能需要拖动按键， 并非所有技能都有target
例如 貂蝉1技能与2技能是方向性技能，所以当预测出button为skill1或者skill2时，skill X与Skill Z预测结果是有意义的，对于貂蝉3技能，skill X与skill Z无意义descript
Legal action mask (对应state_dict["legal_action"]):

通过环境规则直接屏蔽掉不合理的预测action
比如CD中技能,不能释放
可以加快训练速度，避免无意义的探索descript
action具体的执行流程
AI选取action的流程如下：

从which_button中选择采取什么行动

选择which_button维度中具有最大值的索引所对应的legal action，作为英雄下一步执行的动作

根据which_button选中的结果，去计算要执行的动作需要的参数，分为以下情况：

方向型技能：需要读取位置偏置offset_x, offset_z和target
位置型技能：需要读取位置偏置offset_x, offset_z和target
目标性技能：只需读取target
下面，我们选择一个方向型技能的执行过程作为示例：

descript

绿色方块为main_hero的位置，黄色方块为选中的target的位置。
我们以target位置作为offset坐标系的中心点，因此它在offset维度对应的索引为(21, 21)。
然后，我们根据offset_x，offset_z的找到最终的位置（下例中以offset_x=25,offset_z=15为例），图中绿色即为以黄色点为中心，offset为(25, 15)的最终目标位置。
那么连接红色的英雄位置和绿色方块位置的红色箭头方向即为实际技能释放方向。
注:

这里如果直接把 (skill_x, skill_z) 设置成 (21, 21), 技能的释放方向就是目标所在的位置
这里图示例子的offset_x和offset_z是 42 * 42 的, 在1v1的环境中, 应该是 16 * 16
move_x和move_z同理, 当action为move的时候, 以自身为target
原始帧状态信息
对应state_dicts[agent_id]["frame_state"]

类型	字段说明	字段名	字段类型	备注
FrameState	帧结构	frameNo	signed int	帧号
FrameState	帧结构	hero_states	vector, HeroState	英雄状态列表
FrameState	帧结构	npc_states	vector, ActorState	非英雄角色状态列表
FrameState	帧结构	bullets	vector, Bullet	子弹列表
FrameState	帧结构	cakes	vector, Cake	功能物件列表(血包等)
FrameState	帧结构	equip_infos	vector, EquipInfo	装备信息列表
FrameState	帧结构	frame_action	vector, FrameAction	死亡事件
FrameState	帧结构	map_state	bool	大乱斗地图坍塌状态，false未坍塌，true已坍塌
类型	字段说明	字段名	字段类型	备注
HeroState	英雄属性	player_id	signed int	玩家id
HeroState	英雄属性	actor_state	ActorState	角色状态
HeroState	英雄属性	skill_state	SkillState	技能状态
HeroState	英雄属性	equip_state	EquipState	装备状态
HeroState	英雄属性	buff_state	BuffState	增益状态
HeroState	英雄属性	level	signed int	等级
HeroState	英雄属性	exp	signed int	经验
HeroState	英雄属性	money	signed int	金钱
HeroState	英雄属性	revive_time	signed int	复活时间
HeroState	英雄属性	killCnt	signed int	击杀次数
HeroState	英雄属性	deadCnt	signed int	死亡次数
HeroState	英雄属性	assistCnt	signed int	助攻次数
HeroState	英雄属性	moneyCnt	signed int	经济总量
HeroState	英雄属性	totalHurt	signed int	总输出
HeroState	英雄属性	totalHurtToHero	signed int	对英雄伤害输出
HeroState	英雄属性	totalBeHurtByHero	signed int	承受英雄伤害
HeroState	英雄属性	passive_skill	vector, PassiveSkill	被动技能
HeroState	英雄属性	real_cmd	vector, CmdPkg	实际执行指令
HeroState	英雄属性	takeHurtInfos	vector, TakeHurtInfo	承受伤害序列
HeroState	英雄属性	canAbortCurSkill	bool	是否可以打断当前技能
HeroState	英雄属性	returnCityAbortInfo	vector, ReturnCityAbortInfo	打断当前技能信息
HeroState	英雄属性	isInGrass	bool	判断英雄是否在草丛中
HeroState	英雄属性	protectInfo	vector, ProtectInfo	护盾信息
HeroState	英雄属性	canBuyEquip	bool	是否可以购买装备
类型	字段说明	字段名	字段类型	备注
ActorState	角色状态	config_id	signed int	区分英雄
ActorState	角色状态	runtime_id	signed int	区分红蓝方
ActorState	角色状态	actor_type	ActorType	Actor主类型
ActorState	角色状态	sub_type	ActorSubType	Actor子类型
ActorState	角色状态	camp	enum, COM_PLAYERCAMP	所属阵营: 区分红蓝方
ActorState	角色状态	behav_mode	enum, ObjBehaviMode	角色当前行为状态(比如死亡等)
ActorState	角色状态	location	VInt3	位置
ActorState	角色状态	forward	VInt3	朝向
ActorState	角色状态	hp	signed int	当前血量
ActorState	角色状态	max_hp	signed int	最大血量
ActorState	角色状态	values	ActorValue	英雄属性
ActorState	角色状态	abilities	bool	能力状态
ActorState	角色状态	attack_range	signed int	攻击范围
ActorState	角色状态	attack_target	signed int	攻击目标
ActorState	角色状态	kill_income	signed int	含金值
ActorState	角色状态	hit_target_info	vector, HitTargetInfo	命中的目标
ActorState	角色状态	camp_visible	vector, bool	可见阵营，camp_visible[0]表示是否蓝方可见，camp_visible[1]表示是否红方可见
ActorState	角色状态	sight_area	signed int	视野
ActorState	角色状态	buff_state	ActorBuffState	增益状态
ActorState	角色状态	hurt_hero_state	HurtHeroInfo	对英雄的伤害
类型	字段说明	字段名	字段类型	备注
SkillState	技能状态	slot_states	vector, SkillSlotState	技能槽
类型	字段说明	字段名	字段类型	备注
ActorValue	英雄属性	phy_atk	signed int	物理攻击
ActorValue	英雄属性	phy_def	signed int	物理防御
ActorValue	英雄属性	mgc_atk	signed int	魔法攻击
ActorValue	英雄属性	mgc_def	signed int	魔法防御
ActorValue	英雄属性	mov_spd	signed int	移动速度
ActorValue	英雄属性	atk_spd	signed int	攻速加成
ActorValue	英雄属性	ep	signed int	当前能量
ActorValue	英雄属性	max_ep	signed int	最大能量
ActorValue	英雄属性	hp_recover	signed int	生命回复
ActorValue	英雄属性	ep_recover	signed int	能量回复
ActorValue	英雄属性	phy_armor_hurt	signed int	物理护甲穿透
ActorValue	英雄属性	mgc_armor_hurt	signed int	魔法护甲穿透
ActorValue	英雄属性	crit_rate	signed int	爆击率
ActorValue	英雄属性	crit_effe	signed int	爆击效果
ActorValue	英雄属性	phy_vamp	signed int	物理吸血
ActorValue	英雄属性	mgc_vamp	signed int	魔法吸血
ActorValue	英雄属性	cd_reduce	signed int	冷却缩减
ActorValue	英雄属性	ctrl_reduce	signed int	韧性
类型	字段说明	字段名	字段类型	备注
SkillSlotState	技能槽状态	configId	signed int	配置ID
SkillSlotState	技能槽状态	slot_type	SkillSlotType	技能槽
SkillSlotState	技能槽状态	level	signed int	等级
SkillSlotState	技能槽状态	usable	bool	能否使用
SkillSlotState	技能槽状态	cooldown	signed int	CD剩余时长
SkillSlotState	技能槽状态	cooldown_max	signed int	CD总长
SkillSlotState	技能槽状态	usedTimes	signed int	释放次数
SkillSlotState	技能槽状态	hitHeroTimes	signed int	命中英雄释放次数
SkillSlotState	技能槽状态	succUsedInFrame	signed int	当前帧成功使用次数
SkillSlotState	技能槽状态	nextConfigID	signed int	多段技能的下一个技能id
SkillSlotState	技能槽状态	comboEffectTime	signed int	组合技激活余留时间
类型	字段说明	字段名	字段类型	备注
EquipState	装备列表	equips	vector, EquipSlot	装备列表
类型	字段说明	字段名	字段类型	备注
EquipSlot	装备槽	configId	signed int	配置ID（对应装备配置表）
EquipSlot	装备槽	buyPrice	signed int	购买单价
EquipSlot	装备槽	amount	signed int	数量
EquipSlot	装备槽	active_skill	vector, ActiveSkill	主动技能
EquipSlot	装备槽	passive_skill	vector, PassiveSkill	被动技能
类型	字段说明	字段名	字段类型	备注
BuffState	增益状态	buff_skills	vector, BuffSkillState	产生的增益组
BuffState	增益状态	buff_marks	vector, BuffMarkState	印记状态组
类型	字段说明	字段名	字段类型	备注
BuffMarkState	印记状态	origin_actorId	signed int	施放者ID
BuffMarkState	印记状态	configId	signed int	配置ID
BuffMarkState	印记状态	layer	signed int	层数
类型	字段说明	字段名	字段类型	备注
BuffSkillState	增益技能状态	configId	signed int	配置ID
BuffSkillState	增益技能状态	startTime	uint64	开始时间
BuffSkillState	增益技能状态	times	signed int	生效次数
BuffSkillState	增益技能状态	effectType	signed int	类型
类型	字段说明	字段名	字段类型	备注
CmdPkg	指令信息	command_type	enum, CommandType	指令类型
CmdPkg	指令信息	prm_move_pos	PrmMovePos	指向目标移动命令参数
CmdPkg	指令信息	prm_move_dir	PrmMoveDir	指向方向移动命令参数
CmdPkg	指令信息	prm_attack_common	PrmAttackCommon	普通攻击命令参数
CmdPkg	指令信息	prm_attack_topos	PrmAttackToPos	移动施法命令参数
CmdPkg	指令信息	prm_attack_actor	PrmAttackActor	锁定目标命令参数
CmdPkg	指令信息	prm_obj_skill	PrmObjSkill	目标性技能命令参数
CmdPkg	指令信息	prm_dir_skill	PrmDirSkill	方向性技能命令参数
CmdPkg	指令信息	prm_pos_skill	PrmPosSkill	位置性技能命令参数
CmdPkg	指令信息	prm_learn_skill	PrmLearnSkill	学习技能命令参数
CmdPkg	指令信息	prm_buy_equip	PrmBuyEquip	购买装备命令参数
CmdPkg	指令信息	prm_sell_equip	PrmSellEquip	出售装备命令参数
类型	字段说明	字段名	字段类型	备注
PrmMovePos	指向目标移动命令参数	destPos	VInt3	目标位置
类型	字段说明	字段名	字段类型	备注
VInt3		x	signed int	x坐标
VInt3		y	signed int	y坐标
VInt3		z	signed int	z坐标
类型	字段说明	字段名	字段类型	备注
PrmMoveDir	指向方向移动命令参数	degree	int	角度
PrmMoveDir	指向方向移动命令参数	seq	int	序号
类型	字段说明	字段名	字段类型	备注
PrmAttackCommon	普通攻击命令参数	start	int	0按下, 1抬起
PrmAttackCommon	普通攻击命令参数	actorID	int	目标actor的runtime id
类型	字段说明	字段名	字段类型	备注
PrmAttackToPos	移动施法命令参数	destPos	VInt3	目标位置
PrmAttackActor	锁定目标命令参数	actorID	int	目标actor的runtime id
类型	字段说明	字段名	字段类型	备注
PrmObjSkill	目标性技能命令参数	actorID	int	目标actor的runtime id
PrmObjSkill	目标性技能命令参数	skillID	int	技能ID
PrmObjSkill	目标性技能命令参数	slotType	enum, SkillSlotType	施放技能槽
PrmDirSkill	方向性技能命令参数	actorID	int	目标actor的runtime id
PrmDirSkill	方向性技能命令参数	skillID	int	技能ID
PrmDirSkill	方向性技能命令参数	slotType	enum, SkillSlotType	施放技能槽
PrmDirSkill	方向性技能命令参数	degree	int	施法角度
PrmPosSkill	位置性技能命令参数	destPos	VInt3	目标位置
PrmPosSkill	位置性技能命令参数	skillID	int	技能ID
PrmPosSkill	位置性技能命令参数	slotType	enum, SkillSlotType	施放技能槽
类型	字段说明	字段名	字段类型	备注
PrmLearnSkill	学习技能	slotType	enum, SkillSlotType	目标技能槽
PrmLearnSkill	学习技能	level	int	目标技能等级
类型	字段说明	字段名	字段类型	备注
PrmBuyEquip	购买装备	equipId	int	装备id
PrmBuyEquip	购买装备	obj_id	int	英雄runtime id
PrmSellEquip		equipIndex	int	装备槽位
类型	字段说明	字段名	字段类型	备注
ProtectInfo	护盾信息	protectType	ProtectType	护盾类型
ProtectInfo	护盾信息	protectValue	unsigned int32	护盾值
类型	字段说明	字段名	字段类型	备注
HitTargetInfo	命中目标信息	hit_target	signed int	命中目标的runtime_id
HitTargetInfo	命中目标信息	skill_id	signed int	技能ID
HitTargetInfo	命中目标信息	slot_type	enum, SkillSlotType	施放技能槽
类型	字段说明	字段名	字段类型	备注
ActorBuffState	增益状态	buff_skills	vector, BuffSkillState	产生的增益组
ActorBuffState	增益状态	buff_marks	vector, BuffMarkState	印记状态组
类型	字段说明	字段名	字段类型	备注
Bullet	子弹信息	runtime_id	signed int	运行时id
Bullet	子弹信息	camp	COM_PLAYERCAMP	所属阵营
Bullet	子弹信息	source_actor	signed int	源actorID
Bullet	子弹信息	slot_type	SkillSlotType	施放技能槽
Bullet	子弹信息	skill_id	signed int	所属技能
Bullet	子弹信息	location	VInt3	当前位置
Bullet	子弹信息	action	string	子弹AGE
Bullet	子弹信息	born_pos	VInt3	生成位置
Bullet	子弹信息	use_dir	VInt3	使用方向
Bullet	子弹信息	use_frame	uint32	使用帧号
Bullet	子弹信息	sight_range	signed int	视野范围
Bullet	子弹信息	target_actor	signed int	目标actorID
Bullet	子弹信息	size	VInt3	碰撞物大小（目前只考虑box类型）
类型	字段说明	字段名	字段类型	备注
Cake	功能物件	configId	signed int	配置ID(对应神符配置表)
Cake	功能物件	collider	SphereCollider	碰撞体
类型	字段说明	字段名	字段类型	备注
EquipInfo	装备信息	equip_id	signed int	装备ID
EquipInfo	装备信息	equip_price	signed int	装备价格
EquipInfo	装备信息	equip_atoms	signed int	子装备ID
类型	字段说明	字段名	字段类型	备注
FrameAction	帧状态	dead_action	DeadAction	死亡事件
类型	字段说明	字段名	字段类型	备注
DeadAction	死亡事件	death	ActionActorInfo	死亡对象
DeadAction	死亡事件	killer	ActionActorInfo	击杀者
DeadAction	死亡事件	assist_set	ActionActorInfo	助攻者